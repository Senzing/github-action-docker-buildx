# action.yml
name: Run docker buildx build
description: Prepare the environment and run docker buildx build.
author: support@senzing.com

inputs:
   dockerContext:
      default: "."
      description: Context (directory) of the docker build process
   dockerOptions:
      description: Additional options to pass to docker buildx build
   dockerPassword:
      default: ${{ secrets.DOCKERHUB_PASSWORD }}
      description: Password for Docker registry
   dockerPlatforms:
      default: linux/amd64
      description: Comma-separated list of docker platforms to build (hint - See output of docker buildx ls)
   dockerRepository:
      description: Docker repository (e.g. senzing/senzingapi-runtime)
      required: true
   dockerServer:
      default: docker.io
      description: Docker registry server
   dockerUsername:
      default: ${{ secrets.DOCKERHUB_USERNAME }}
      description: Username for Docker registry

runs:
   using: composite
   steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
           fetch-depth: "0"
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker list platforms
        run: docker buildx ls
      - name: Dockerhub login
        run: echo ${{ inputs.dockerPassword }} | docker login -u ${{ inputs.dockerUsername }} --password-stdin ${{ inputs.dockerServer }}
      - name: Docker build images
        run: |
           docker buildx build \
              --platform ${{ inputs.dockerPlatforms }} \
              --tag ${{ inputs.dockerServer }}/${{ inputs.dockerRepository }}:${{ github.ref_name }} \
              --tag ${{ inputs.dockerServer }}/${{ inputs.dockerRepository }}:latest \
              ${{ inputs.dockerOptions }} \
              ${{ inputs.dockerContext }}

branding:
   icon: upload-cloud
   color: green
